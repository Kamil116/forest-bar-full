networks:
  dev:

services:
  nginx:
    image: nginx:stable-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - './nginx.conf:/etc/nginx/nginx.conf'
      - '/etc/letsencrypt:/etc/letsencrypt'
    depends_on:
      backend:
        condition: service_started
      frontend:
        condition: service_started
    entrypoint: |
      sh -c "
        apk add --no-cache netcat-openbsd > /dev/null 2>&1 || true;
        echo 'Waiting for frontend and backend to be ready...';
        until (nc -z frontend 3000 2>/dev/null && nc -z backend 8000 2>/dev/null); do
          echo 'Services not ready, waiting...';
          sleep 2;
        done;
        echo 'Services are ready, starting nginx...';
        nginx -g 'daemon off;'
      "
    networks:
      - dev
    

  backend:
    build:
      context: ./backend
    networks:
      - dev

  frontend:
    build:
      context: ./frontend
    networks:
      - dev