# üì± SMS –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –†–§

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ SMS —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ SMS.RU –∏ SMSC.RU.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env` –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ:

```bash
cp .env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env`:

```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç–µ SECRET_KEY!
SECRET_KEY=–≤–∞—à-–¥–ª–∏–Ω–Ω—ã–π-—Å–ª—É—á–∞–π–Ω—ã–π-—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-–∫–ª—é—á

# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–≤—å—Ç–µ true (–∫–æ–¥—ã –±—É–¥—É—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏)
SMS_TEST_MODE=true

# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ø–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ https://sms.ru/
SMSRU_API_ID=–≤–∞—à-api-id-–æ—Ç-sms-ru
SMS_TEST_MODE=false
```

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
python init_db.py
```

### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
python main.py
```

API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8000

## üì° API Endpoints

### 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS –∫–æ–¥

**POST** `/auth/send-code`

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

**Request:**
```json
{
  "phone": "+79991234567"
}
```

**Response:**
```json
{
  "message": "SMS –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
  "phone": "+79991234567",
  "expires_in_seconds": 300
}
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ–º–µ—Ä–∞:
- `+79991234567`
- `79991234567`
- `89991234567`

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω

**POST** `/auth/verify-code`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –∏–∑ SMS –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω.

**Request:**
```json
{
  "phone": "+79991234567",
  "code": "123456"
}
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_id": 1,
  "phone": "+79991234567"
}
```

### 3. –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

**GET** `/auth/me`

–¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (Bearer —Ç–æ–∫–µ–Ω).

**Headers:**
```
Authorization: Bearer <–≤–∞—à-jwt-—Ç–æ–∫–µ–Ω>
```

**Response:**
```json
{
  "id": 1,
  "phone": "+79991234567",
  "is_active": true,
  "created_at": "2024-11-06T12:00:00"
}
```

### 4. –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

**POST** `/auth/logout`

–¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é. –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å JWT —Ç–æ–∫–µ–Ω.

**Headers:**
```
Authorization: Bearer <–≤–∞—à-jwt-—Ç–æ–∫–µ–Ω>
```

**Response:**
```json
{
  "message": "–£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"
}
```

## üîê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö:

```javascript
// JavaScript –ø—Ä–∏–º–µ—Ä
fetch('http://localhost:8000/auth/me', {
  headers: {
    'Authorization': 'Bearer ' + accessToken
  }
})
```

```python
# Python –ø—Ä–∏–º–µ—Ä
import requests

headers = {
    'Authorization': f'Bearer {access_token}'
}
response = requests.get('http://localhost:8000/auth/me', headers=headers)
```

## üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 1: SMS.RU (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://sms.ru/
2. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å (–æ—Ç 100 —Ä—É–±–ª–µ–π)
3. –ü–æ–ª—É—á–∏—Ç–µ API ID –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
4. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
   ```env
   SMSRU_API_ID=–≤–∞—à-api-id
   SMS_TEST_MODE=false
   ```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~2-4 —Ä—É–±–ª—è –∑–∞ SMS

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ–π API
- –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
- –•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 2: SMSC.RU

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://smsc.ru/
2. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å
3. –ü–æ–ª—É—á–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
4. –í —Ñ–∞–π–ª–µ `sms_service.py` –∏–∑–º–µ–Ω–∏—Ç–µ:
   ```python
   # –í–º–µ—Å—Ç–æ
   sms_service = SMSService()
   
   # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ
   sms_service = SMSCService()
   ```
5. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
   ```env
   SMSC_LOGIN=–≤–∞—à-–ª–æ–≥–∏–Ω
   SMSC_PASSWORD=–≤–∞—à-–ø–∞—Ä–æ–ª—å
   SMS_TEST_MODE=false
   ```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–ü—Ä–∏ `SMS_TEST_MODE=true` –∫–æ–¥—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞:

```
üì± [TEST MODE] SMS –∫–æ–¥ –¥–ª—è +79991234567: 123456
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Swagger UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000/docs
2. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "auth"
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ endpoints:
   - `/auth/send-code` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
   - `/auth/verify-code` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
   - `/auth/me` - –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```bash
# 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
curl -X POST "http://localhost:8000/auth/send-code" \
  -H "Content-Type: application/json" \
  -d '{"phone": "+79991234567"}'

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ (–∫–æ–¥ –±—É–¥–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞)
curl -X POST "http://localhost:8000/auth/verify-code" \
  -H "Content-Type: application/json" \
  -d '{"phone": "+79991234567", "code": "123456"}'

# 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
curl -X GET "http://localhost:8000/auth/me" \
  -H "Authorization: Bearer <–ø–æ–ª—É—á–µ–Ω–Ω—ã–π-—Ç–æ–∫–µ–Ω>"
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

1. **SECRET_KEY** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª–∏–Ω–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á:
   ```python
   # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–∞–∫:
   import secrets
   print(secrets.token_urlsafe(32))
   ```

2. **HTTPS** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

3. **Rate Limiting** - –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É SMS:
   ```python
   # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É slowapi
   pip install slowapi
   ```

4. **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ–¥–∞** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `main.py`)

5. **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `auth_utils.py`)

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ users
- `id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `phone` - –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `is_active` - –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `created_at` - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- `updated_at` - –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞ sms_codes
- `id` - ID –∫–æ–¥–∞
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `code` - 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
- `is_used` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ –∫–æ–¥
- `expires_at` - –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
- `created_at` - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ö–æ–¥—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `SMS_TEST_MODE=true` - –∫–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ SMS.RU –∏–ª–∏ SMSC.RU
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

### –û—à–∏–±–∫–∞ "–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –∫–æ–¥"

- –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ 5 –º–∏–Ω—É—Ç
- –ö–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –∫–æ–¥–∞

### JWT —Ç–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞: `Authorization: Bearer <—Ç–æ–∫–µ–Ω>`
- –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 7 –¥–Ω–µ–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `SECRET_KEY` –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [SMS.RU API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://sms.ru/api)
- [SMSC.RU API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://smsc.ru/api/)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [JWT.io](https://jwt.io/) - –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–æ–≤

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### React –ø—Ä–∏–º–µ—Ä

```javascript
// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
const sendCode = async (phone) => {
  const response = await fetch('http://localhost:8000/auth/send-code', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone })
  });
  return response.json();
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
const verifyCode = async (phone, code) => {
  const response = await fetch('http://localhost:8000/auth/verify-code', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone, code })
  });
  const data = await response.json();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
  localStorage.setItem('access_token', data.access_token);
  return data;
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const getUser = async () => {
  const token = localStorage.getItem('access_token');
  const response = await fetch('http://localhost:8000/auth/me', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  return response.json();
};
```

### Python –ø—Ä–∏–º–µ—Ä

```python
import requests

# –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
def send_code(phone: str):
    response = requests.post(
        'http://localhost:8000/auth/send-code',
        json={'phone': phone}
    )
    return response.json()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
def verify_code(phone: str, code: str):
    response = requests.post(
        'http://localhost:8000/auth/verify-code',
        json={'phone': phone, 'code': code}
    )
    return response.json()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
def get_user(access_token: str):
    response = requests.get(
        'http://localhost:8000/auth/me',
        headers={'Authorization': f'Bearer {access_token}'}
    )
    return response.json()
```
